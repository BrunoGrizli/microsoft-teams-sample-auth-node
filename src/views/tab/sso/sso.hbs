<!--
// Copyright (c) Microsoft Corporation
// All rights reserved.
//
// MIT License:
// Permission is hereby granted, free of charge, to any person obtaining
// a copy of this software and associated documentation files (the
// "Software"), to deal in the Software without restriction, including
// without limitation the rights to use, copy, modify, merge, publish,
// distribute, sublicense, and/or sell copies of the Software, and to
// permit persons to whom the Software is furnished to do so, subject to
// the following conditions:
//
// The above copyright notice and this permission notice shall be
// included in all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED ""AS IS"", WITHOUT WARRANTY OF ANY KIND,
// EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
// NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
// LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
// OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
// WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
-->

<html>

<head>
    <title>SSO Authentication Sample</title>
</head>

<body>
    <p>
        This sample shows the basics of an sso authentication flow in a Microsoft Teams tab.
    </p>
    <p>
        Click on the "SSO Login" button below to login to Azure AD, get an id_token for your profile
        information.
    </p>

    <!-- Login button -->
    <button onclick="sso()">SSO Login</button>

    <!-- Result -->

    <p>
        <div id=" divError" style="display: none"></div>
        <div id="divProfile" style="display: none">
            <div><b>Name:</b> <span id="profileDisplayName" /></div>
            <div><b>Prefered Username:</b> <span id="profileUpn" /></div>
            <div><b>Object id:</b> <span id="profileObjectId" /></div>
        </div>
    </p>

    <script src="https://code.jquery.com/jquery-3.1.1.js"
        integrity="sha384-VC7EHu0lDzZyFfmjTPJq+DFyIn8TUGAJbEtpXquazFVr00Q/OOx//RjiZ9yU9+9m"
        crossorigin="anonymous"></script>
    <script src="https://statics.teams.cdn.office.net/sdk/v1.6.0/js/MicrosoftTeams.min.js"
        integrity="sha384-mhp2E+BLMiZLe7rDIzj19WjgXJeI32NkPvrvvZBrMi5IvWup/1NUfS5xuYN5S3VT" \
        crossorigin="anonymous"></script>
    <script src="https://secure.aadcdn.microsoftonline-p.com/lib/1.0.17/js/adal.min.js"
        integrity="sha384-BIOS/65fbAsb2XiCCSTlZSTTl0ZgqkOU522dpyk5meOnN2EOQ3uH+QpqEtoAtmBn"
        crossorigin="anonymous"></script>

    <script type="text/javascript">
        microsoftTeams.initialize();

        function sso() {
            var authTokenRequest = {
                successCallback: function (result) {

                    showUserInformation(result);
                },
                failureCallback: function (error) { handleAuthError(error) }
            };
            microsoftTeams.authentication.getAuthToken(authTokenRequest);
        }

        // Get the user's profile information
        function showUserInformation(idToken) {

           var profile = decodeToken(idToken);
           $("#profileDisplayName").text(profile.name);
           $("#profileUpn").text(profile.preferred_username);
           $("#profileObjectId").text(profile.oid);
           $("#divProfile").css({ display: "" });
           $("#divError").css({ display: "none" });
        }

        function decodeToken(token) {
            var base64Url = token.split('.')[1];
            var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            var jsonPayload =
                decodeURIComponent(
                    atob(base64)
                        .split('')
                        .map(
                            function (c) {
                                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                            })
                        .join('')
                );

            return JSON.parse(jsonPayload);
        }
        // Show error information
        function handleAuthError(reason) {
            console.log('reason: ', reason);
            $("#divError").text(reason).css({ display: "" });
            $("#divProfile").css({ display: "none" });
        }

    </script>
</body>

</html>
